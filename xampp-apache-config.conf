# ===========================================
# Barber Platform Apache Configuration for XAMPP
# ===========================================

# Virtual Host Configuration for Barber Platform API
<VirtualHost *:80>
    ServerName barber-platform.local
    ServerAlias api.barber-platform.local
    DocumentRoot "C:/xampp/htdocs/barber-platform-backend"
    
    # API Proxy Configuration
    ProxyPreserveHost On
    ProxyPass /api/ http://localhost:3000/api/
    ProxyPassReverse /api/ http://localhost:3000/api/
    
    # Static files handling
    Alias /uploads "C:/xampp/htdocs/barber-platform-backend/uploads"
    <Directory "C:/xampp/htdocs/barber-platform-backend/uploads">
        Options -Indexes
        AllowOverride None
        Require all granted
        
        # Security headers for uploaded files
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
    </Directory>
    
    # CORS Configuration
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"
    
    # Handle preflight requests
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
    
    # Security Headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Rate Limiting
    <IfModule mod_evasive24.c>
        DOSHashTableSize    2048
        DOSPageCount        20
        DOSSiteCount        50
        DOSPageInterval     1
        DOSSiteInterval     1
        DOSBlockingPeriod   600
    </IfModule>
    
    # Logging
    ErrorLog "C:/xampp/apache/logs/barber-platform-error.log"
    CustomLog "C:/xampp/apache/logs/barber-platform-access.log" combined
    
    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>
    
    # Cache Control
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 1 month"
        ExpiresByType image/jpeg "access plus 1 month"
        ExpiresByType image/gif "access plus 1 month"
        ExpiresByType image/png "access plus 1 month"
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/pdf "access plus 1 month"
        ExpiresByType text/javascript "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType application/x-javascript "access plus 1 month"
        ExpiresByType application/json "access plus 1 hour"
    </IfModule>
</VirtualHost>

# ===========================================
# HTTPS Configuration (Optional)
# ===========================================

<VirtualHost *:443>
    ServerName barber-platform.local
    ServerAlias api.barber-platform.local
    DocumentRoot "C:/xampp/htdocs/barber-platform-backend"
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile "C:/xampp/apache/conf/ssl.crt/server.crt"
    SSLCertificateKeyFile "C:/xampp/apache/conf/ssl.key/server.key"
    
    # API Proxy Configuration
    ProxyPreserveHost On
    ProxyPass /api/ http://localhost:3000/api/
    ProxyPassReverse /api/ http://localhost:3000/api/
    
    # Static files handling
    Alias /uploads "C:/xampp/htdocs/barber-platform-backend/uploads"
    <Directory "C:/xampp/htdocs/barber-platform-backend/uploads">
        Options -Indexes
        AllowOverride None
        Require all granted
    </Directory>
    
    # Security Headers for HTTPS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS Configuration
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"
    
    # Logging
    ErrorLog "C:/xampp/apache/logs/barber-platform-ssl-error.log"
    CustomLog "C:/xampp/apache/logs/barber-platform-ssl-access.log" combined
</VirtualHost>

# ===========================================
# Global Apache Configuration
# ===========================================

# Enable required modules
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule expires_module modules/mod_expires.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule ssl_module modules/mod_ssl.so

# ===========================================
# PHP Configuration (if needed)
# ===========================================

<IfModule mod_php.c>
    php_value upload_max_filesize 5M
    php_value post_max_size 5M
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value memory_limit 256M
    php_value date.timezone "UTC"
</IfModule>

# ===========================================
# Directory Security
# ===========================================

<Directory "C:/xampp/htdocs/barber-platform-backend">
    Options -Indexes
    AllowOverride All
    Require all granted
    
    # Block access to sensitive files
    <FilesMatch "\.(env|log|sql|bak|backup)$">
        Require all denied
    </FilesMatch>
    
    # Block access to node_modules
    <DirectoryMatch "node_modules">
        Require all denied
    </DirectoryMatch>
    
    # Block access to .git directory
    <DirectoryMatch "\.git">
        Require all denied
    </DirectoryMatch>
</Directory>

# ===========================================
# Error Pages
# ===========================================

ErrorDocument 404 /error/404.html
ErrorDocument 500 /error/500.html
ErrorDocument 403 /error/403.html

# ===========================================
# Logging Configuration
# ===========================================

# Custom log format for API requests
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-agent}i\" %D" api_format

# ===========================================
# Performance Optimization
# ===========================================

# KeepAlive Configuration
KeepAlive On
KeepAliveTimeout 5
MaxKeepAliveRequests 100

# Timeout Configuration
Timeout 300
KeepAliveTimeout 5

# ===========================================
# Security Configuration
# ===========================================

# Hide Apache version
ServerTokens Prod
ServerSignature Off

# Disable server signature
<IfModule mod_headers.c>
    Header unset Server
    Header always unset X-Powered-By
</IfModule>

# ===========================================
# Development vs Production Configuration
# ===========================================

# Development settings (uncomment for development)
# <IfDefine DEVELOPMENT>
#     # Enable detailed error reporting
#     php_flag display_errors On
#     php_value error_reporting "E_ALL"
#     
#     # Disable caching for development
#     <IfModule mod_expires.c>
#         ExpiresActive Off
#     </IfModule>
# </IfDefine>

# Production settings (uncomment for production)
# <IfDefine PRODUCTION>
#     # Disable error reporting
#     php_flag display_errors Off
#     php_value error_reporting "E_NONE"
#     
#     # Enable caching
#     <IfModule mod_expires.c>
#         ExpiresActive On
#     </IfModule>
# </IfDefine>
